<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS CRYPTO V7 - ç¡¬é«”é©—è­‰ç‰ˆ</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0c; --card: #16161d; --text: #f0f0f0; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
        header { background: #1a241a; padding: 20px; text-align: center; border-bottom: 2px solid var(--primary); font-weight: bold; color: var(--primary); letter-spacing: 2px; }
        .container { padding: 20px; max-width: 500px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h3 { margin-top: 0; color: var(--primary); font-size: 1.1rem; }
        input, textarea { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 12px; margin: 10px 0; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.2s; font-size: 1rem; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { background: #444 !important; color: #888; cursor: not-allowed; }
        .btn-write { background: var(--primary); color: #000; }
        .btn-read { background: #6f42c1; color: #fff; }
        #status { font-size: 0.8rem; text-align: center; margin-bottom: 15px; color: #888; }
        #viewArea { display: none; margin-top: 20px; border-top: 2px solid var(--primary); padding-top: 20px; animation: fadeIn 0.5s; }
        .verify-pass { color: var(--primary); font-weight: bold; font-size: 1.2rem; }
        .verify-fail { color: #ff4444; font-weight: bold; font-size: 1.2rem; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,255,136,0.9); color: #000; padding: 10px 25px; border-radius: 30px; font-weight: bold; display: none; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>RMS CRYPTO V7</header>

<div class="container">
    <div id="status">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

    <div class="card">
        <h3>âœï¸ ç°½ç½²å¯«å…¥ (ç¶å®šç¡¬é«” ID)</h3>
        <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 10px;">è«‹å…ˆç”¨å…¶ä»– App è®€å–æ¨™ç±¤ UID ä¸¦å¡«å…¥ï¼Œä»¥é˜²æ­¢å¡ç‰‡è¢«è¤‡è£½ã€‚</p>
        <input type="text" id="tagUid" placeholder="NFC ç¡¬é«” UID (ä¾‹å¦‚: 04:A1:B2:C3)">
        <input type="text" id="editTitle" placeholder="ç‰©ä»¶åç¨± / æ¨™é¡Œ">
        <textarea id="editDesc" rows="3" placeholder="è©³ç´°æè¿°å…§å®¹..."></textarea>
        <button id="writeBtn" class="btn btn-write" onclick="saveAndSign()">å°å°ä¸¦å¯«å…¥æ¨™ç±¤</button>
    </div>

    <div class="card">
        <h3>ğŸ“– å®‰å…¨é©—è­‰è®€å–</h3>
        <button id="readBtn" class="btn btn-read" onclick="startSecureRead()">é–‹å§‹æ„Ÿæ‡‰æ¨™ç±¤</button>
        <div id="viewArea">
            <div id="vResult"></div>
            <div style="font-size: 0.8rem; color: #888; margin: 10px 0;">ç¶å®šç¡¬é«” IDï¼š<span id="vUid"></span></div>
            <h2 id="vTitle" style="margin: 5px 0;"></h2>
            <p id="vDesc" style="line-height: 1.6; color: #ccc;"></p>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    let db, keyPair;

    // åˆå§‹åŒ–è³‡æ–™åº«èˆ‡é‡‘é‘°
    const dbReq = indexedDB.open("RMS_V7_DB", 1);
    dbReq.onupgradeneeded = (e) => e.target.result.createObjectStore("keys");
    dbReq.onsuccess = (e) => {
        db = e.target.result;
        const tx = db.transaction("keys", "readonly");
        const getReq = tx.objectStore("keys").get("main_keypair");
        getReq.onsuccess = async () => {
            if (getReq.result) {
                keyPair = getReq.result;
                document.getElementById('status').innerText = "ğŸŸ¢ å®‰å…¨æ¨¡çµ„å·²å°±ç·’ (ç¡¬é«”ç¶å®šé–‹å•Ÿ)";
            } else {
                await generateKeys();
            }
        };
    };

    async function generateKeys() {
        document.getElementById('status').innerText = "ğŸ”‘ æ­£åœ¨ç”ŸæˆåŠ å¯†é‡‘é‘°...";
        keyPair = await window.crypto.subtle.generateKey(
            { name: "RSASSA-PKCS1-v1_5", modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" },
            true, ["sign", "verify"]
        );
        const tx = db.transaction("keys", "readwrite");
        tx.objectStore("keys").put(keyPair, "main_keypair");
        document.getElementById('status').innerText = "ğŸŸ¢ é‡‘é‘°ç”ŸæˆæˆåŠŸ";
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2500);
    }

    // å¯«å…¥é‚è¼¯ï¼šå°‡ UID æ‰å…¥æ•¸ä½ç°½ç« 
    async function saveAndSign() {
        const uid = document.getElementById('tagUid').value.trim().toUpperCase();
        const title = document.getElementById('editTitle').value;
        if (!uid || !title) return showToast("âŒ UID èˆ‡æ¨™é¡Œä¸å¯ç‚ºç©º");

        const btn = document.getElementById('writeBtn');
        btn.disabled = true; btn.innerText = "ğŸ”’ æ­£åœ¨å°å°ç¡¬é«” ID...";

        try {
            const pairId = "RMS_" + Date.now();
            const combinedData = uid + "|" + pairId; 
            const signature = await window.crypto.subtle.sign("RSASSA-PKCS1-v1_5", keyPair.privateKey, new TextEncoder().encode(combinedData));
            const sigBase64 = btoa(String.fromCharCode(...new Uint8Array(signature)));

            const record = { title, desc: document.getElementById('editDesc').value, uid, sig: sigBase64 };
            localStorage.setItem(pairId, JSON.stringify(record));

            const ndef = new NDEFReader();
            await ndef.write(`${pairId}|${sigBase64}`);
            showToast("âœ… å¯«å…¥æˆåŠŸï¼");
            setTimeout(() => location.reload(), 1500);
        } catch (e) {
            showToast("âŒ å¤±æ•—ï¼š" + e.message);
            btn.disabled = false; btn.innerText = "å°å°ä¸¦å¯«å…¥æ¨™ç±¤";
        }
    }

    // è®€å–é‚è¼¯ï¼šé©—è­‰å…§å®¹èˆ‡ç¡¬é«” UID æ˜¯å¦åŒ¹é…
    async function startSecureRead() {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            showToast("ğŸ“¡ æƒæä¸­ï¼Œè«‹é è¿‘æ¨™ç±¤...");
            
            ndef.onreading = async ({ message }) => {
                const raw = new TextDecoder().decode(message.records[0].data);
                const [pairId, sigBase64] = raw.split('|');
                
                const localData = JSON.parse(localStorage.getItem(pairId) || "null");
                if (!localData) return showToast("âŒ æœ¬åœ°ç„¡æ­¤æ¨™ç±¤ç´€éŒ„");

                const combinedData = localData.uid + "|" + pairId;
                const sigArray = new Uint8Array(atob(sigBase64).split("").map(c => c.charCodeAt(0)));
                const isValid = await window.crypto.subtle.verify("RSASSA-PKCS1-v1_5", keyPair.publicKey, sigArray, new TextEncoder().encode(combinedData));

                const view = document.getElementById('viewArea');
                view.style.display = 'block';

                if (isValid) {
                    showToast("ğŸ›¡ï¸ é©—è­‰æˆåŠŸ");
                    document.getElementById('vResult').innerHTML = "<span class='verify-pass'>ğŸ›¡ï¸ åŸå§‹ç¡¬é«”åŒ¹é…æˆåŠŸ</span>";
                    document.getElementById('vUid').innerText = localData.uid;
                    document.getElementById('vTitle').innerText = localData.title;
                    document.getElementById('vDesc').innerText = localData.desc;
                } else {
                    showToast("âš ï¸ é©—è­‰å¤±æ•—");
                    document.getElementById('vResult').innerHTML = "<span class='verify-fail'>âš ï¸ è­¦å‘Šï¼šç¡¬é«”åºè™Ÿä¸ç¬¦ï¼</span>";
                    document.getElementById('vTitle').innerText = "éæ³•è¤‡è£½æ¨™ç±¤";
                    document.getElementById('vDesc').innerText = "åµæ¸¬åˆ°å…§å®¹å·²è¢«æ¬ç§»è‡³ä¸åŒ UID çš„æ¨™ç±¤ä¸­ã€‚";
                }
            };
        } catch (e) { showToast("âŒ å•Ÿå‹•å¤±æ•—"); }
    }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
