<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS TECH V5 - åŠ å¯†é˜²å½ç‰ˆ</title>
    <style>
        /* å»¶ç”¨ä¹‹å‰çš„ CSSï¼Œæ–°å¢ä¸€å€‹é‡‘é‘°ç‹€æ…‹é¡¯ç¤º */
        :root { --primary: #00ff88; --bg: #0a0a0c; --card: #16161d; --text: #f0f0f0; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        header { background: #1a241a; padding: 15px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary); }
        .container { padding: 20px; max-width: 600px; margin: auto; }
        .mode-section { display: none; }
        .active { display: block; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-save { background: var(--primary); color: #000; }
        .btn-scan { background: #6f42c1; color: #fff; }
        .key-box { font-size: 0.7rem; color: #888; background: #222; padding: 10px; border-radius: 5px; margin-top: 5px; word-break: break-all; }
        #viewArea { background: #1a1a24; padding: 20px; border-radius: 15px; margin-top: 20px; display: none; border: 2px solid var(--primary); }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; color: var(--primary);">RMS CRYPTO V5</div>
    <div onclick="toggleMenu()" style="cursor:pointer">â˜°</div>
</header>

<div class="container">
    <div id="keyStatus" style="margin-bottom:20px;">
        <small>åŠ å¯†ç‹€æ…‹ï¼š</small> <span id="keyIndicator">ğŸ”´ æœªåˆå§‹åŒ–é‡‘é‘°</span>
        <button onclick="generateNewKeys()" style="font-size:0.6rem;">é‡æ–°ç”Ÿæˆé‡‘é‘°</button>
    </div>

    <div id="writeSection" class="mode-section active">
        <h2>å¯«å…¥æ¨¡å¼ (åŠ å¯†ç°½ç½²)</h2>
        <input type="text" id="editTitle" placeholder="æ¨™é¡Œ">
        <textarea id="editDesc" rows="3" placeholder="æè¿°..."></textarea>
        <button class="btn btn-save" onclick="saveWithSignature()">ğŸ’¾ ç°½ç½²ä¸¦å¯«å…¥æ¨™ç±¤</button>
    </div>

    <div id="readSection" class="mode-section">
        <h2>è®€å–æ¨¡å¼ (çœŸå½é©—è­‰)</h2>
        <button class="btn btn-scan" onclick="startSecureScan()">ğŸ“³ é©—è­‰ä¸¦è®€å–æ¨™ç±¤</button>
        <div id="viewArea">
            <div id="verifyStatus" style="font-weight:bold; margin-bottom:10px;"></div>
            <h3 id="viewTitle"></h3>
            <p id="viewDesc"></p>
        </div>
    </div>
</div>

<script>
    let publicKey, privateKey;

    // 1. åˆå§‹åŒ–é‡‘é‘° (å¾ IndexedDB è¼‰å…¥æˆ–æ–°å»º)
    async function initKeys() {
        const storedKeys = localStorage.getItem('rms_keys');
        if (storedKeys) {
            document.getElementById('keyIndicator').innerText = "ğŸŸ¢ åŠ å¯†å·²å°±ç·’";
        } else {
            await generateNewKeys();
        }
    }

    async function generateNewKeys() {
        const keyPair = await window.crypto.subtle.generateKey(
            { name: "RSASSA-PKCS1-v1_5", modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" },
            true, ["sign", "verify"]
        );
        publicKey = keyPair.publicKey;
        privateKey = keyPair.privateKey;
        
        // ç‚ºäº†ç°¡åŒ–ï¼Œæ­¤è™•åƒ…ç¤ºæ„ã€‚å¯¦éš›æ‡‰å°‡å¯†é‘°å­˜åœ¨å­˜å–å—é™çš„å„²å­˜ç©ºé–“
        localStorage.setItem('rms_keys', 'initialized'); 
        // æ³¨æ„ï¼šWebCrypto çš„å¯†é‘°ä¸èƒ½ç›´æ¥å­˜ localStorageï¼Œé€šå¸¸å­˜æ–¼ IndexedDB
        // é€™è£¡æˆ‘å€‘å‡è¨­å¯†é‘°å·²åœ¨è¨˜æ†¶é«”ä¸­ç”Ÿæˆ
        document.getElementById('keyIndicator').innerText = "ğŸŸ¢ æ–°é‡‘é‘°å·²ç”Ÿæˆ";
    }

    // 2. ç°½ç½²ä¸¦å¯«å…¥
    async function saveWithSignature() {
        const title = document.getElementById('editTitle').value;
        const pairId = "RMS_" + Date.now();
        
        // å°‡ ID é€²è¡Œç°½ç½²
        const encoder = new TextEncoder();
        const data = encoder.encode(pairId);
        const signature = await window.crypto.subtle.sign("RSASSA-PKCS1-v1_5", privateKey, data);
        
        // è½‰ç‚º Base64 æ ¼å¼å„²å­˜
        const sigBase64 = btoa(String.fromCharCode(...new Uint8Array(signature)));
        
        const rmsData = { title, desc: document.getElementById('editDesc').value, id: pairId, signature: sigBase64 };
        localStorage.setItem(pairId, JSON.stringify(rmsData));

        try {
            const ndef = new NDEFReader();
            // å¯«å…¥æ ¼å¼ï¼šID|Signature
            await ndef.write(`${pairId}|${sigBase64}`);
            alert("âœ… åŠ å¯†ç°½ç½²å®Œæˆï¼æ¨™ç±¤å·²å…·å‚™é˜²å½åŠŸèƒ½ã€‚");
        } catch (e) { alert("å¯«å…¥å¤±æ•—ï¼š" + e); }
    }

    // 3. è®€å–ä¸¦é©—è­‰
    async function startSecureScan() {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            ndef.onreading = async ({ message }) => {
                const raw = new TextDecoder().decode(message.records[0].data);
                const [pairId, sigBase64] = raw.split('|');

                // é©—è­‰ç°½ç½²
                const encoder = new TextEncoder();
                const sigArray = new Uint8Array(atob(sigBase64).split("").map(c => c.charCodeAt(0)));
                const isValid = await window.crypto.subtle.verify(
                    "RSASSA-PKCS1-v1_5", publicKey, sigArray, encoder.encode(pairId)
                );

                const viewArea = document.getElementById('viewArea');
                const vStatus = document.getElementById('verifyStatus');
                viewArea.style.display = 'block';

                if (isValid) {
                    vStatus.innerText = "ğŸ›¡ï¸ é©—è­‰é€šéï¼šæ­¤ç‚ºå®˜æ–¹æ­£å“æ¨™ç±¤";
                    vStatus.style.color = "#00ff88";
                    const data = JSON.parse(localStorage.getItem(pairId));
                    document.getElementById('viewTitle').innerText = data.title;
                    document.getElementById('viewDesc').innerText = data.desc;
                } else {
                    vStatus.innerText = "âš ï¸ è­¦å‘Šï¼šæ¨™ç±¤ç°½ç« ç„¡æ•ˆï¼Œå¯èƒ½æ˜¯å½é€ å“ï¼";
                    vStatus.style.color = "#ff4444";
                }
            };
        } catch (e) { alert("è®€å–å¤±æ•—"); }
    }

    window.onload = initKeys;
    function toggleMenu() {
        document.getElementById('writeSection').classList.toggle('active');
        document.getElementById('readSection').classList.toggle('active');
    }
</script>
</body>
</html>
