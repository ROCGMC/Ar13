<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS CRYPTO V6.1</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0c; --card: #16161d; --text: #f0f0f0; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
        
        header { 
            background: #1a241a; padding: 20px; text-align: center; 
            border-bottom: 2px solid var(--primary); font-weight: bold; 
            color: var(--primary); letter-spacing: 2px;
        }

        .container { padding: 20px; max-width: 500px; margin: auto; }
        
        .card { 
            background: var(--card); padding: 20px; border-radius: 15px; 
            margin-bottom: 20px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        h3 { margin-top: 0; color: var(--primary); font-size: 1.1rem; }

        input, textarea { 
            width: 100%; background: #222; border: 1px solid #444; 
            color: white; padding: 12px; margin: 10px 0; border-radius: 8px; 
            box-sizing: border-box; font-size: 1rem;
        }

        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 12px; 
            font-weight: bold; cursor: pointer; transition: all 0.2s ease;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            font-size: 1rem;
        }

        .btn:active { transform: scale(0.96); opacity: 0.8; }
        .btn:disabled { background: #444 !important; color: #888; cursor: not-allowed; }

        .btn-write { background: var(--primary); color: #000; }
        .btn-read { background: #6f42c1; color: #fff; }

        /* æƒæä¸­çš„è„ˆå‹•å‹•ç•« */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0px rgba(111, 66, 193, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(111, 66, 193, 0); }
            100% { box-shadow: 0 0 0 0px rgba(111, 66, 193, 0); }
        }
        .scanning { animation: pulse 1.5s infinite; position: relative; }

        #status-bar { text-align: center; font-size: 0.75rem; color: #666; margin-bottom: 15px; }
        
        #viewArea { 
            display: none; margin-top: 20px; border-top: 1px solid #444; 
            padding-top: 20px; animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .verify-pass { color: var(--primary); font-weight: bold; display: block; margin-bottom: 10px; }
        .verify-fail { color: #ff4444; font-weight: bold; display: block; margin-bottom: 10px; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); color: #000; padding: 12px 24px;
            border-radius: 50px; font-size: 0.9rem; font-weight: bold;
            z-index: 9999; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<header>RMS CRYPTO V6.1</header>

<div class="container">
    <div id="status-bar">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

    <div class="card">
        <h3>âœï¸ å®‰å…¨ç°½ç½²å¯«å…¥</h3>
        <input type="text" id="editTitle" placeholder="ç‰©å“åç¨±/æ¨™é¡Œ">
        <textarea id="editDesc" rows="3" placeholder="è©³ç´°æè¿°å…§å®¹..."></textarea>
        <button id="writeBtn" class="btn btn-write" onclick="saveAndSign()">å„²å­˜ä¸¦å¯«å…¥æ¨™ç±¤</button>
    </div>

    <div class="card">
        <h3>ğŸ“– çœŸå½é©—è­‰è®€å–</h3>
        <button id="readBtn" class="btn btn-read" onclick="startSecureRead()">é–‹å§‹æ„Ÿæ‡‰æ¨™ç±¤</button>
        
        <div id="viewArea">
            <div id="vResult"></div>
            <h2 id="vTitle" style="margin: 5px 0; color: var(--primary);"></h2>
            <p id="vDesc" style="line-height: 1.6; color: #ccc;"></p>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    let db;
    let keyPair = {};

    // é¡¯ç¤ºåé¥‹æç¤º
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 2500);
    }

    // åˆå§‹åŒ– IndexedDB å„²å­˜é‡‘é‘° (é˜²æ­¢ç§é‘°åˆ·æ–°éºå¤±)
    const request = indexedDB.open("RMS_Security_DB", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("crypto_keys");
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        initSecurity();
    };

    async function initSecurity() {
        const tx = db.transaction("crypto_keys", "readonly");
        const store = tx.objectStore("crypto_keys");
        const getReq = store.get("rms_v6_keypair");
        
        getReq.onsuccess = async () => {
            if (getReq.result) {
                keyPair = getReq.result;
                document.getElementById('status-bar').innerText = "ğŸ›¡ï¸ å®‰å…¨æ¨¡çµ„å·²å°±ç·’ (æ°¸ä¹…é‡‘é‘°)";
            } else {
                document.getElementById('status-bar').innerText = "ğŸ”‘ æ­£åœ¨ç”Ÿæˆå”¯ä¸€èº«ä»½é‡‘é‘°...";
                await generateAndStoreKeys();
            }
        };
    }

    async function generateAndStoreKeys() {
        const newKeys = await window.crypto.subtle.generateKey(
            { name: "RSASSA-PKCS1-v1_5", modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" },
            true, ["sign", "verify"]
        );
        keyPair = newKeys;
        const tx = db.transaction("crypto_keys", "readwrite");
        tx.objectStore("crypto_keys").put(newKeys, "rms_v6_keypair");
        document.getElementById('status-bar').innerText = "ğŸ›¡ï¸ èº«ä»½é‡‘é‘°ç”Ÿæˆå®Œç•¢";
    }

    // å¯«å…¥é‚è¼¯
    async function saveAndSign() {
        const btn = document.getElementById('writeBtn');
        const title = document.getElementById('editTitle').value;
        if (!title) return showToast("âš ï¸ è«‹è¼¸å…¥æ¨™é¡Œ");

        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "ğŸ”’ æ­£åœ¨åŠ å¯†ç°½ç½²...";

        try {
            const pairId = "RMS_" + Date.now();
            const encoder = new TextEncoder();
            
            // ä½¿ç”¨ç§é‘°ç°½å
            const signature = await window.crypto.subtle.sign(
                "RSASSA-PKCS1-v1_5", keyPair.privateKey, encoder.encode(pairId)
            );
            const sigBase64 = btoa(String.fromCharCode(...new Uint8Array(signature)));

            // å­˜å…¥æœ¬åœ°è³‡æ–™
            const rmsData = { title, desc: document.getElementById('editDesc').value, id: pairId, sig: sigBase64 };
            localStorage.setItem(pairId, JSON.stringify(rmsData));

            btn.innerText = "ğŸ“¡ è«‹é è¿‘æ¨™ç±¤...";
            showToast("è«‹å°‡ NFC æ¨™ç±¤è²¼è¿‘æ‰‹æ©Ÿæ„Ÿæ‡‰å€");

            const ndef = new NDEFReader();
            await ndef.write(`${pairId}|${sigBase64}`);
            
            showToast("âœ… å¯«å…¥æˆåŠŸä¸¦å·²å°å°ç°½ç« ï¼");
            btn.innerText = "âœ… å®Œæˆ";
            setTimeout(() => { location.reload(); }, 1500);
        } catch (e) {
            showToast("âŒ éŒ¯èª¤ï¼š" + e.message);
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    // è®€å–é‚è¼¯
    async function startSecureRead() {
        const btn = document.getElementById('readBtn');
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            
            btn.classList.add('scanning');
            btn.innerText = "ğŸ“¡ æ­£åœ¨å°‹æ‰¾æ¨™ç±¤...";
            showToast("æ„Ÿæ‡‰ä¸­...");

            ndef.onreading = async ({ message }) => {
                btn.classList.remove('scanning');
                btn.innerText = "ğŸ” é©—è­‰ç°½ç« ä¸­...";
                
                const raw = new TextDecoder().decode(message.records[0].data);
                const [pairId, sigBase64] = raw.split('|');
                
                if (!pairId || !sigBase64) {
                    showToast("âŒ ç„¡æ³•è­˜åˆ¥çš„æ¨™ç±¤æ ¼å¼");
                    return;
                }

                // ä½¿ç”¨å…¬é‘°é©—è­‰
                const sigArray = new Uint8Array(atob(sigBase64).split("").map(c => c.charCodeAt(0)));
                const isValid = await window.crypto.subtle.verify(
                    "RSASSA-PKCS1-v1_5", keyPair.publicKey, sigArray, new TextEncoder().encode(pairId)
                );

                const view = document.getElementById('viewArea');
                view.style.display = 'block';
                btn.innerText = "ğŸ“– é–‹å§‹æ„Ÿæ‡‰æ¨™ç±¤";

                if (isValid) {
                    showToast("ğŸ›¡ï¸ é©—è­‰é€šéï¼šæ­¤ç‚ºåŸå§‹æ¨™ç±¤");
                    document.getElementById('vResult').innerHTML = "<span class='verify-pass'>ğŸ›¡ï¸ æ•¸ä½ç°½ç« é©—è­‰æˆåŠŸ (æ­£å“)</span>";
                    const localData = JSON.parse(localStorage.getItem(pairId) || "{}");
                    document.getElementById('vTitle').innerText = localData.title || "æœªçŸ¥å…§å®¹";
                    document.getElementById('vDesc').innerText = localData.desc || "ç„¡æè¿°è³‡æ–™";
                } else {
                    showToast("âš ï¸ è­¦å‘Šï¼šæ¨™ç±¤å¯èƒ½è¢«è¤‡è£½æˆ–ç¯¡æ”¹ï¼");
                    document.getElementById('vResult').innerHTML = "<span class='verify-fail'>âš ï¸ è­¦å‘Šï¼šç°½ç« ç„¡æ•ˆ (å½é€ å“)</span>";
                    document.getElementById('vTitle').innerText = "éæ³•å­˜å–";
                    document.getElementById('vDesc').innerText = "æ­¤æ¨™ç±¤çš„ç°½ç« èˆ‡æ‚¨çš„é‡‘é‘°ä¸åŒ¹é…ã€‚";
                }
            };
        } catch (e) {
            showToast("âŒ ç„¡æ³•å•Ÿå‹•æƒæï¼š" + e.message);
        }
    }

    // è¨»å†Š PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
</script>
</body>
</html>
