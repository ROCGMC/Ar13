<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS ç§‘æŠ€ - å¯¦é«”å­˜å–ç³»çµ±</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00d2ff; --bg: #0a0a0c; --card: #16161d; --text: #f0f0f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        
        /* Header & Nav */
        header { background: #1a1a24; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); position: sticky; top: 0; z-index: 100; }
        .menu-btn { cursor: pointer; font-size: 1.8rem; color: var(--primary); }
        
        /* Drawer Menu */
        #drawer { position: fixed; top: 0; right: -280px; width: 260px; height: 100%; background: var(--card); transition: 0.3s ease-in-out; z-index: 1000; padding-top: 60px; box-shadow: -5px 0 15px rgba(0,0,0,0.7); }
        .menu-item { padding: 20px; border-bottom: 1px solid #333; cursor: pointer; font-size: 1.1rem; }
        .menu-item:hover { background: #252530; color: var(--primary); }

        /* Container */
        .container { padding: 20px; max-width: 600px; margin: auto; }
        .mode-section { display: none; animation: fadeIn 0.4s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Elements */
        input, textarea { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 12px; margin: 10px 0; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        .btn-save { background: var(--primary); color: #000; }
        .btn-scan { background: #6f42c1; color: #fff; }
        .btn:active { transform: scale(0.98); }

        #preview { width: 100%; border-radius: 12px; margin-top: 15px; display: none; border: 1px solid #444; }
        .status-bar { text-align: center; font-size: 0.8rem; opacity: 0.5; margin-bottom: 20px; }
        
        #viewArea { background: #1a1a24; padding: 20px; border-radius: 15px; margin-top: 20px; display: none; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; letter-spacing: 3px; color: var(--primary);">RMS TECH</div>
    <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
</header>

<div id="drawer">
    <div class="menu-item" onclick="connectUsb()">ğŸ”Œ 1. é€£ç·š USB è£ç½®</div>
    <div class="menu-item" onclick="switchMode('write')">âœï¸ 2. å¯«å…¥æ–°é…æª”</div>
    <div class="menu-item" onclick="switchMode('read')">ğŸ“– 3. è®€å– NFC æ¨™ç±¤</div>
</div>

<div class="container">
    <div id="usbStatus" class="status-bar">USB ç‹€æ…‹ï¼šæœªé€£ç·š</div>

    <div id="writeSection" class="mode-section">
        <h2 style="color:var(--primary)">å¯«å…¥æ¨¡å¼</h2>
        <input type="text" id="editTitle" placeholder="è«‹è¼¸å…¥æ¨™é¡Œ">
        <textarea id="editDesc" rows="4" placeholder="è«‹è¼¸å…¥æ•˜è¿°å­—ä¸²..."></textarea>
        <label style="font-size: 0.8rem; opacity: 0.7;">é™„åŠ åœ–ç‰‡ï¼š</label>
        <input type="file" id="fileInput" accept="image/*" onchange="previewImage(this)">
        <img id="preview">
        <button class="btn btn-save" onclick="saveAndPair()">ğŸ’¾ å„²å­˜ä¸¦å¯«å…¥ NFC</button>
    </div>

    <div id="readSection" class="mode-section active">
        <h2 style="color:var(--primary)">è®€å–æ¨¡å¼</h2>
        <p style="opacity:0.7;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¾Œï¼Œé è¿‘ NFC æ¨™ç±¤å³å¯è‡ªå‹•é–‹å•Ÿ USB å…§çš„é…å°æª”ã€‚</p>
        <button class="btn btn-scan" onclick="startScan()">ğŸ“³ é–‹å§‹æ„Ÿæ‡‰æ¨™ç±¤</button>
        
        <div id="viewArea">
            <h3 id="viewTitle" style="margin-top:0; color:var(--primary);"></h3>
            <p id="viewDesc" style="line-height:1.6;"></p>
            <img id="viewImg" style="width:100%; border-radius:8px; margin-top:10px;">
        </div>
    </div>
</div>

<script>
    let rmsDirHandle;
    let base64Image = "";

    // PWA Service Worker è¨»å†Š
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    function toggleMenu() {
        const drawer = document.getElementById('drawer');
        drawer.style.right = drawer.style.right === '0px' ? '-280px' : '0px';
    }

    function switchMode(mode) {
        document.querySelectorAll('.mode-section').forEach(s => s.classList.remove('active'));
        document.getElementById(mode + 'Section').classList.add('active');
        toggleMenu();
    }

    async function connectUsb() {
        try {
            const root = await window.showDirectoryPicker();
            rmsDirHandle = await root.getDirectoryHandle('RMS', { create: true });
            document.getElementById('usbStatus').innerText = "USB ç‹€æ…‹ï¼š/RMS å·²å°±ç·’";
            toggleMenu();
        } catch (e) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºä¿é¸æ“‡ USB æ ¹ç›®éŒ„"); }
    }

    function previewImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            base64Image = e.target.result;
            const img = document.getElementById('preview');
            img.src = base64Image;
            img.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    async function saveAndPair() {
        if (!rmsDirHandle) return alert("è«‹å…ˆå¾é¸å–®é€£ç·š USBï¼");
        const title = document.getElementById('editTitle').value;
        const desc = document.getElementById('editDesc').value;
        if (!title) return alert("æ¨™é¡Œä¸èƒ½ç‚ºç©º");

        const pairId = "RMS_" + Date.now();

        try {
            // 1. å¯«å…¥ USB
            const rmsData = { title, desc, image: base64Image, id: pairId, time: new Date().toLocaleString() };
            const fileHandle = await rmsDirHandle.getFileHandle(`${pairId}.rms`, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(rmsData));
            await writable.close();

            // 2. å¯«å…¥ NFC
            alert("è«‹é è¿‘ NFC æ¨™ç±¤é€²è¡Œå¯¦é«”é…å°...");
            const ndef = new NDEFReader();
            await ndef.write(pairId);
            
            alert("âœ… é…å°æˆåŠŸï¼\nè³‡æ–™å·²å­˜å…¥ USBï¼Œæ¨™ç±¤å·²å¯«å…¥ç´¢å¼•ã€‚");
            location.reload(); 
        } catch (e) { alert("éŒ¯èª¤ï¼š" + e); }
    }

    async function startScan() {
        if (!rmsDirHandle) return alert("è«‹å…ˆé€£ç·š USBï¼");
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            alert("ğŸ“¡ æ­£åœ¨æƒæï¼Œè«‹é è¿‘æ¨™ç±¤...");
            ndef.onreading = async ({ message }) => {
                const decoder = new TextDecoder();
                const pairId = decoder.decode(message.records[0].data);
                
                try {
                    const fileHandle = await rmsDirHandle.getFileHandle(`${pairId}.rms`);
                    const file = await fileHandle.getFile();
                    const data = JSON.parse(await file.text());
                    
                    document.getElementById('viewArea').style.display = 'block';
                    document.getElementById('viewTitle').innerText = data.title;
                    document.getElementById('viewDesc').innerText = data.desc;
                    document.getElementById('viewImg').src = data.image || "";
                    document.getElementById('viewImg').style.display = data.image ? "block" : "none";
                } catch (e) { alert("æ‰¾ä¸åˆ°é…å°æª”æ¡ˆï¼Œè«‹ç¢ºä¿ USB å·²é€£ç·šä¸”å…§å®¹æ­£ç¢ºã€‚"); }
            };
        } catch (e) { alert("æƒæå¤±æ•—ï¼š" + e); }
    }
</script>
</body>
</html>
