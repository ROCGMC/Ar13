<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC æ™ºèƒ½åº«å­˜</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icon.png" type="image/png">
    <meta name="theme-color" content="#2c3e50"> <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap'); /* å°å…¥ç§‘æŠ€æ„Ÿå­—é«” */

        body {
            font-family: 'Roboto Mono', monospace;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); /* æ·±è‰²æ¼¸è®ŠèƒŒæ™¯ */
            color: #ecf0f1; /* æ·ºè‰²æ–‡å­— */
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 450px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(44, 62, 80, 0.8); /* åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(5px); /* æ¯›ç»ç’ƒæ•ˆæœ */
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            border: 1px solid rgba(70, 96, 119, 0.5);
        }
        h2, h3 {
            color: #ecf0f1;
            text-align: center;
            margin-top: 0;
            border-bottom: 1px dashed rgba(236, 240, 241, 0.2);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        input, textarea {
            width: calc(100% - 24px); /* æ¸›å» padding */
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #4a667b;
            border-radius: 8px;
            background: #3a506b;
            color: #ecf0f1;
            font-family: 'Roboto Mono', monospace;
            font-size: 1em;
            box-sizing: border-box;
        }
        input::placeholder, textarea::placeholder {
            color: #95a5a6;
        }
        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-family: 'Roboto Mono', monospace;
        }
        .btn-primary {
            background: #3498db; /* è—è‰² */
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #2ecc71; /* ç¶ è‰² */
            color: white;
        }
        .btn-secondary:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        #status-message {
            margin-top: 20px;
            color: #ecf0f1;
            font-size: 0.9em;
            background: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(236, 240, 241, 0.1);
            max-width: 90%;
            word-break: break-all;
        }
        #editArea {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed rgba(236, 240, 241, 0.2);
        }
        #activeID {
            color: #2ecc71;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸš€ NFC æ™ºèƒ½åº«å­˜ç³»çµ±</h2>

        <div class="card">
            <h3>[ 1 ] åˆå§‹åŒ–æ¨™ç±¤</h3>
            <p style="font-size: 0.8em; color: #bdc3c7;">ç‚ºç©ºç™½NFCè²¼ç´™æŒ‡å®šå”¯ä¸€ID (ä¾‹å¦‚: BOX_A01)</p>
            <input type="text" id="tagIDInput" placeholder="è¼¸å…¥æ¨™ç±¤ID">
            <button class="btn-primary" onclick="writeTagID()">å¯«å…¥æ¨™ç±¤ID</button>
        </div>

        <div class="card">
            <h3>[ 2 ] æƒæèˆ‡ç®¡ç†</h3>
            <p style="font-size: 0.8em; color: #bdc3c7;">æ„Ÿæ‡‰å·²åˆå§‹åŒ–æ¨™ç±¤ï¼ŒæŸ¥çœ‹æˆ–ç·¨è¼¯å…§å®¹</p>
            <button class="btn-secondary" onclick="startNFCScan()">å•Ÿå‹•æƒææ¨¡å¼</button>
            
            <div id="editArea" style="display:none;">
                <p>ç›®å‰æ´»å‹•æ¨™ç±¤ï¼š<span id="activeID"></span></p>
                <textarea id="itemsContent" rows="7" placeholder="è¼¸å…¥æ­¤æ¨™ç±¤æ‰€ä»£è¡¨çš„ç‰©å“æ¸…å–®ã€æè¿°ç­‰..."></textarea>
                <button class="btn-primary" onclick="saveTagData()">å„²å­˜è‡³æœ¬åœ°</button>
            </div>
        </div>
    </div>

    <div id="status-message">æº–å‚™å°±ç·’...</div>

    <script>
        // PWA Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker: Registered'))
                    .catch(err => console.error('Service Worker: Registration failed:', err));
            });
        }

        const statusMessage = document.getElementById('status-message');
        let currentActiveTagID = ""; // ç”¨ä¾†å„²å­˜ç›®å‰æ­£åœ¨è™•ç†çš„æ¨™ç±¤ID

        // --- é¡¯ç¤ºç‹€æ…‹è¨Šæ¯ ---
        function setStatus(message) {
            statusMessage.innerText = message;
        }

        // --- å¯«å…¥æ¨™ç±¤ ID ---
        async function writeTagID() {
            const tagID = document.getElementById('tagIDInput').value.trim();
            if (!tagID) {
                setStatus("è«‹è¼¸å…¥ä¸€å€‹æ¨™ç±¤IDï¼");
                return;
            }
            
            if (!('NDEFReader' in window)) {
                setStatus("éŒ¯èª¤: æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web NFCã€‚è«‹ä½¿ç”¨ Android Chrome 89+ã€‚");
                return;
            }

            try {
                const ndef = new NDEFReader();
                setStatus(`è«‹æ„Ÿæ‡‰NFCè²¼ç´™ä»¥å¯«å…¥ ID: ${tagID}...`);
                await ndef.write(tagID); // ç›´æ¥å¯«å…¥ç´”æ–‡å­— ID
                setStatus(`ID "${tagID}" å¯«å…¥æˆåŠŸï¼`);
                alert(`æ¨™ç±¤ ID "${tagID}" å·²æˆåŠŸå¯«å…¥è²¼ç´™ã€‚`);
            } catch (error) {
                setStatus(`å¯«å…¥å¤±æ•—: ${error.message}`);
                console.error("NFC å¯«å…¥éŒ¯èª¤:", error);
                alert(`å¯«å…¥å¤±æ•—: ${error.message}\nè«‹ç¢ºèªï¼š\n1. æ‰‹æ©ŸNFCå·²é–‹å•Ÿã€‚\n2. æ‰‹æ©Ÿå·²é è¿‘è²¼ç´™ã€‚\n3. è²¼ç´™å¯å¯«å…¥ã€‚`);
            }
        }

        // --- å•Ÿå‹•æƒææ¨¡å¼ ---
        async function startNFCScan() {
            if (!('NDEFReader' in window)) {
                setStatus("éŒ¯èª¤: æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web NFCã€‚è«‹ä½¿ç”¨ Android Chrome 89+ã€‚");
                return;
            }

            try {
                const ndef = new NDEFReader();
                setStatus("æƒææ¨¡å¼å•Ÿå‹•...è«‹æ„Ÿæ‡‰æ¨™ç±¤ã€‚");
                await ndef.scan();
                
                // ç›£è½è®€å–äº‹ä»¶
                ndef.onreading = event => {
                    const decoder = new TextDecoder();
                    // å‡è¨­æˆ‘å€‘åªè®€å–ç¬¬ä¸€å€‹ç´€éŒ„ (é€šå¸¸å°±æ˜¯æˆ‘å€‘å¯«å…¥çš„ID)
                    const readID = decoder.decode(event.message.records[0].data);
                    currentActiveTagID = readID; // è¨­å®šç›®å‰æ´»èºçš„æ¨™ç±¤ID
                    
                    navigator.vibrate(200); // æ‰‹æ©Ÿéœ‡å‹•æç¤ºæˆåŠŸ
                    setStatus(`å·²åµæ¸¬åˆ°æ¨™ç±¤ ID: ${readID}`);
                    displayEditArea(readID);
                };

                ndef.onreadingerror = error => {
                    setStatus(`è®€å–æ¨™ç±¤å¤±æ•—: ${error.message}`);
                    console.error("NFC è®€å–éŒ¯èª¤:", error);
                };

            } catch (error) {
                setStatus(`ç„¡æ³•å•Ÿå‹•æƒæ: ${error.message}`);
                console.error("NFC å•Ÿå‹•éŒ¯èª¤:", error);
                alert(`ç„¡æ³•å•Ÿå‹•æƒæ: ${error.message}\nè«‹ç¢ºèªï¼š\n1. æ‰‹æ©ŸNFCå·²é–‹å•Ÿã€‚\n2. æ‚¨çš„è£ç½®æ”¯æ´Web NFCã€‚`);
            }
        }

        // --- é¡¯ç¤ºç·¨è¼¯å€ä¸¦è¼‰å…¥æœ¬åœ°è³‡æ–™ ---
        function displayEditArea(tagID) {
            document.getElementById('editArea').style.display = "block";
            document.getElementById('activeID').innerText = tagID;
            
            // å¾ localStorage è¼‰å…¥è³‡æ–™ (ä½¿ç”¨ä¸€å€‹å‰ç¶´é¿å…è¡çª)
            const storedContent = localStorage.getItem(`NFC_INVENTORY_${tagID}`);
            document.getElementById('itemsContent').value = storedContent || ""; // å¦‚æœæ²’æœ‰è³‡æ–™å‰‡é¡¯ç¤ºç©ºå­—ä¸²
        }

        // --- å„²å­˜è³‡æ–™åˆ°æœ¬åœ° (localStorage) ---
        function saveTagData() {
            if (!currentActiveTagID) {
                setStatus("æ²’æœ‰æ´»å‹•æ¨™ç±¤å¯å„²å­˜ã€‚è«‹å…ˆæƒææ¨™ç±¤ã€‚");
                return;
            }
            const content = document.getElementById('itemsContent').value;
            localStorage.setItem(`NFC_INVENTORY_${currentActiveTagID}`, content); // å„²å­˜è³‡æ–™
            setStatus(`ID "${currentActiveTagID}" çš„å…§å®¹å·²å„²å­˜è‡³æ‰‹æ©Ÿã€‚`);
            alert("å…§å®¹å·²æˆåŠŸå„²å­˜åˆ°æœ¬åœ°ï¼");
        }
    </script>
</body>
</html>
