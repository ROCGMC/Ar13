<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS ç§‘æŠ€ - æ•¸ä½åŒ–å­˜å–ç³»çµ±</title>
    <style>
        :root { --primary: #007bff; --bg: #0f0f12; --card: #1e1e24; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: var(--card); border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 450px; }
        h1 { color: var(--primary); text-align: center; margin-bottom: 5px; letter-spacing: 2px; }
        .version { text-align: center; font-size: 0.7rem; opacity: 0.6; margin-bottom: 20px; }
        
        /* å¯†ç¢¼è¼¸å…¥å€ */
        .auth-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        input { background: #2a2a32; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; text-align: center; font-size: 1.1rem; }
        .pin-field { grid-column: span 4; letter-spacing: 8px; }
        .alpha-field { grid-column: span 2; text-transform: uppercase; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; width: 100%; margin: 5px 0; }
        .btn-connect { background: var(--primary); color: white; }
        .btn-nfc { background: #6f42c1; color: white; }
        .btn:hover { opacity: 0.8; }
        
        /* æª”æ¡ˆæ¸…å–® */
        #fileList { margin-top: 20px; background: #15151a; border-radius: 10px; padding: 10px; max-height: 300px; overflow-y: auto; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .status-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .locked { background: #dc3545; color: white; }
        .unlocked { background: #28a745; color: white; }
        
        .level-select { width: 100%; padding: 8px; margin-bottom: 15px; background: #2a2a32; color: white; border-radius: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h1>RMS TECH</h1>
    <div class="version">DIGITAL ACCESS SYSTEM | 3-TIER SECURITY</div>

    <button id="btnConnect" class="btn btn-connect">ğŸ”Œ é€£ç·š USB å„²å­˜è£ç½®</button>

    <div id="mainSection" style="display:none; margin-top: 20px;">
        <label>å®‰å…¨å±¤ç´šï¼š</label>
        <select id="levelSelect" class="level-select">
            <option value="1A">Level 1A (8-PIN + 2-Alpha)</option>
            <option value="2SA">Level 2SA (Pure NFC UID)</option>
            <option value="3TA" selected>Level 3TA (NFC + 8-PIN + 2-Alpha)</option>
        </select>

        <div class="auth-grid">
            <input type="password" id="pinInput" class="pin-field" maxlength="8" placeholder="8-DIGIT PIN">
            <input type="text" id="alpha1" class="alpha-field" maxlength="1" placeholder="A">
            <input type="text" id="alpha2" class="alpha-field" maxlength="1" placeholder="B">
        </div>
        
        <button id="btnNfc" class="btn btn-nfc">ğŸ“³ æ„Ÿæ‡‰ NFC æ¨™ç±¤</button>
        <div id="nfcStatus" style="text-align:center; font-size:0.8rem; margin:5px; color:#aaa;">æœªæ„Ÿæ‡‰æ¨™ç±¤</div>

        <div id="fileList">
            <div style="text-align:center; color:#666;">ç­‰å¾…ç›®éŒ„æˆæ¬Š...</div>
        </div>
    </div>
</div>

<script>
    let dirHandle;
    let currentNfcUid = "";
    const SALT = "RMS_TECH_PRIVATE_SALT_2024";

    // 1. é€£ç·š USB
    document.getElementById('btnConnect').onclick = async () => {
        try {
            dirHandle = await window.showDirectoryPicker();
            document.getElementById('mainSection').style.display = 'block';
            document.getElementById('btnConnect').innerText = "âœ… USB å·²å°±ç·’";
            renderFiles();
        } catch (e) { alert("é€£ç·šå–æ¶ˆæˆ–å¤±æ•—"); }
    };

    // 2. NFC è®€å–å™¨
    document.getElementById('btnNfc').onclick = async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            document.getElementById('nfcStatus').innerText = "ğŸ“¡ æ­£åœ¨æ„Ÿæ‡‰...";
            ndef.onreading = event => {
                currentNfcUid = event.serialNumber;
                document.getElementById('nfcStatus').innerText = "âœ… å·²é€£çµæ¨™ç±¤: " + currentNfcUid;
            };
        } catch (e) { alert("æ­¤è£ç½®ä¸æ”¯æ´ NFC æˆ–æ¬Šé™æœªé–‹å•Ÿ"); }
    };

    // 3. æ ¸å¿ƒåŠ è§£å¯†é‹ç®—
    async function getRMSKey(level) {
        const pin = document.getElementById('pinInput').value;
        const a1 = document.getElementById('alpha1').value.toUpperCase();
        const a2 = document.getElementById('alpha2').value.toUpperCase();
        
        if ((level.includes("A") || level === "3TA") && pin.length !== 8) throw "è«‹è¼¸å…¥æ­£ç¢º 8 ä½ PIN";
        if (level.includes("SA") && !currentNfcUid) throw "è«‹å…ˆæ„Ÿæ‡‰ NFC æ¨™ç±¤";
        
        let seed = "";
        if (level === "1A") seed = pin + a1 + a2 + SALT;
        if (level === "2SA") seed = currentNfcUid + SALT;
        if (level === "3TA") seed = pin + a1 + a2 + currentNfcUid + SALT;

        const msgUint8 = new TextEncoder().encode(seed);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        return hashBuffer;
    }

    // 4. æ¸²æŸ“æª”æ¡ˆæ¸…å–®
    async function renderFiles() {
        const list = document.getElementById('fileList');
        list.innerHTML = "";
        for await (const entry of dirHandle.values()) {
            if (entry.kind !== 'file') continue;
            const isRMS = entry.name.endsWith('.rms');
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <span>${entry.name} <span class="status-tag ${isRMS?'locked':'unlocked'}">${isRMS?'åŠ å¯†':'åŸå§‹'}</span></span>
                <button onclick="processFile('${entry.name}')">${isRMS ? 'âš¡ è§£é–' : 'ğŸ”’ åŠ å¯†'}</button>
            `;
            list.appendChild(div);
        }
    }

    // 5. è™•ç†æª”æ¡ˆç¨‹åº
    async function processFile(name) {
        const level = document.getElementById('levelSelect').value;
        try {
            const keyBuffer = await getRMSKey(level);
            const fileHandle = await dirHandle.getFileHandle(name);
            const file = await fileHandle.getFile();
            let buffer = await file.arrayBuffer();
            let bytes = new Uint8Array(buffer);

            if (name.endsWith('.rms')) {
                // è§£å¯†é‚è¼¯
                const checksum = bytes[0]; // ç°¡æ˜“æ ¡é©—
                const failCount = bytes[bytes.length - 1] - 48;

                // æª¢æŸ¥å¯†ç¢¼ (é€™è£¡ä½¿ç”¨ Key çš„ç¬¬ä¸€å€‹ Byte åšç°¡æ˜“ Checksum)
                if (checksum !== new Uint8Array(keyBuffer)[0]) {
                    // å¯†ç¢¼éŒ¯èª¤ï¼šæ›´æ–°å¤±æ•—ç´€éŒ„
                    bytes[bytes.length - 1] += 1;
                    const writable = await fileHandle.createWritable();
                    await writable.write(bytes);
                    await writable.close();
                    alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼ç´€éŒ„å·²æ›´æ–°ã€‚");
                    return;
                }

                if (failCount > 0) alert(`âš ï¸ æ³¨æ„ï¼šæ­¤æª”æ¡ˆå…ˆå‰æœ‰ ${failCount} æ¬¡è¼¸å…¥éŒ¯èª¤ç´€éŒ„ï¼`);
                
                // ä¸‹è¼‰æˆ–é‚„åŸ
                const mode = confirm("å¯†ç¢¼æ­£ç¢ºï¼\n[ç¢ºå®š] åŸåœ°é‚„åŸæª”æ¡ˆ\n[å–æ¶ˆ] åƒ…ä¸‹è¼‰è§£å¯†æª”");
                const decrypted = bytes.slice(1, -1); // å‰é›¢é ­å°¾

                if (mode) {
                    const newHandle = await dirHandle.getFileHandle(name.replace('.rms', ''), { create: true });
                    const w = await newHandle.createWritable();
                    await w.write(decrypted); await w.close();
                    await dirHandle.removeEntry(name);
                } else {
                    const blob = new Blob([decrypted]);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = name.replace('.rms', ''); a.click();
                }

            } else {
                // åŠ å¯†é‚è¼¯
                const header = new Uint8Array([new Uint8Array(keyBuffer)[0]]);
                const footer = new Uint8Array([48]); // '0'
                const combined = new Uint8Array(header.length + bytes.length + footer.length);
                combined.set(header); combined.set(bytes, 1); combined.set(footer, combined.length - 1);

                const newHandle = await dirHandle.getFileHandle(name + '.rms', { create: true });
                const w = await newHandle.createWritable();
                await w.write(combined); await w.close();
                await dirHandle.removeEntry(name);
                alert("ğŸ”’ æª”æ¡ˆåŠ å¯†å®Œæˆï¼");
            }
            renderFiles();
        } catch (e) { alert("éŒ¯èª¤: " + e); }
    }
</script>
</body>
</html>
