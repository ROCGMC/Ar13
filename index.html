<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS CRYPTO V6 - PWA</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0c; --text: #f0f0f0; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #1a241a; padding: 15px; text-align: center; border-bottom: 2px solid var(--primary); font-weight: bold; color: var(--primary); }
        .container { padding: 20px; flex: 1; overflow-y: auto; max-width: 500px; margin: auto; width: 100%; box-sizing: border-box; }
        .card { background: #16161d; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #333; }
        input, textarea { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 12px; margin: 10px 0; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-write { background: var(--primary); color: #000; }
        .btn-read { background: #6f42c1; color: #fff; margin-top: 10px; }
        #status { font-size: 0.8rem; text-align: center; margin: 10px; color: #888; }
        #viewArea { display: none; margin-top: 20px; border-top: 1px solid var(--primary); padding-top: 15px; }
        .verify-pass { color: var(--primary); font-weight: bold; }
        .verify-fail { color: #ff4444; font-weight: bold; }
    </style>
</head>
<body>

<header>RMS CRYPTO V6 - æ°¸ä¹…é‡‘é‘°ç‰ˆ</header>

<div class="container">
    <div id="status">æ­£åœ¨åˆå§‹åŒ–å®‰å…¨æ¨¡çµ„...</div>

    <div class="card">
        <h3>âœï¸ ç°½ç½²å¯«å…¥</h3>
        <input type="text" id="editTitle" placeholder="æ¨™é¡Œ">
        <textarea id="editDesc" rows="3" placeholder="æè¿°å…§å®¹..."></textarea>
        <button class="btn btn-write" onclick="saveAndSign()">å„²å­˜ä¸¦å¯«å…¥æ¨™ç±¤</button>
    </div>

    <div class="card">
        <h3>ğŸ“– é©—è­‰è®€å–</h3>
        <button class="btn btn-read" onclick="startSecureRead()">é–‹å§‹æ„Ÿæ‡‰æ¨™ç±¤</button>
        <div id="viewArea">
            <div id="vResult"></div>
            <h2 id="vTitle"></h2>
            <p id="vDesc"></p>
        </div>
    </div>
</div>

<script>
    let db;
    let keyPair = {};

    // 1. åˆå§‹åŒ– IndexedDB ä¸¦è¼‰å…¥/ç”Ÿæˆé‡‘é‘°
    const request = indexedDB.open("RMS_Crypto_DB", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("keys");
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        loadKeys();
    };

    async function loadKeys() {
        const tx = db.transaction("keys", "readonly");
        const store = tx.objectStore("keys");
        const getReq = store.get("main_keypair");
        
        getReq.onsuccess = async () => {
            if (getReq.result) {
                keyPair = getReq.result;
                document.getElementById('status').innerText = "âœ… å®‰å…¨é‡‘é‘°å·²è¼‰å…¥ (æŒä¹…åŒ–)";
            } else {
                document.getElementById('status').innerText = "ğŸ”‘ æ­£åœ¨ç”Ÿæˆæ°¸ä¹…é‡‘é‘°...";
                await generatePersistentKeys();
            }
        };
    }

    async function generatePersistentKeys() {
        const newKeyPair = await window.crypto.subtle.generateKey(
            { name: "RSASSA-PKCS1-v1_5", modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" },
            true, ["sign", "verify"]
        );
        keyPair = newKeyPair;
        const tx = db.transaction("keys", "readwrite");
        tx.objectStore("keys").put(newKeyPair, "main_keypair");
        document.getElementById('status').innerText = "âœ… æ°¸ä¹…é‡‘é‘°å·²ç”Ÿæˆä¸¦å„²å­˜";
    }

    // 2. ç°½ç½²ä¸¦å¯«å…¥ NFC
    async function saveAndSign() {
        const title = document.getElementById('editTitle').value;
        const desc = document.getElementById('editDesc').value;
        if (!title) return alert("æ¨™é¡Œå¿…å¡«");

        const pairId = "RMS_" + Date.now();
        const encoder = new TextEncoder();
        const signature = await window.crypto.subtle.sign("RSASSA-PKCS1-v1_5", keyPair.privateKey, encoder.encode(pairId));
        const sigBase64 = btoa(String.fromCharCode(...new Uint8Array(signature)));

        const data = { title, desc, id: pairId, sig: sigBase64 };
        localStorage.setItem(pairId, JSON.stringify(data));

        try {
            const ndef = new NDEFReader();
            await ndef.write(`${pairId}|${sigBase64}`);
            alert("âœ… å¯«å…¥æˆåŠŸï¼æ¨™ç±¤å·²å°å°æ•¸ä½ç°½ç« ã€‚");
        } catch (e) { alert("NFC å¯«å…¥å¤±æ•—ï¼š" + e); }
    }

    // 3. è®€å–ä¸¦é©—è­‰
    async function startSecureRead() {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            document.getElementById('status').innerText = "ğŸ“¡ æƒæä¸­ï¼Œè«‹é è¿‘æ¨™ç±¤...";
            
            ndef.onreading = async ({ message }) => {
                const raw = new TextDecoder().decode(message.records[0].data);
                const [pairId, sigBase64] = raw.split('|');
                
                const sigArray = new Uint8Array(atob(sigBase64).split("").map(c => c.charCodeAt(0)));
                const isValid = await window.crypto.subtle.verify(
                    "RSASSA-PKCS1-v1_5", keyPair.publicKey, sigArray, new TextEncoder().encode(pairId)
                );

                const view = document.getElementById('viewArea');
                const vRes = document.getElementById('vResult');
                view.style.display = 'block';

                if (isValid) {
                    vRes.innerHTML = "<span class='verify-pass'>ğŸ›¡ï¸ é©—è­‰é€šéï¼šæ­£å“æ¨™ç±¤</span>";
                    const localData = JSON.parse(localStorage.getItem(pairId) || "{}");
                    document.getElementById('vTitle').innerText = localData.title || "æœªçŸ¥è³‡æ–™";
                    document.getElementById('vDesc').innerText = localData.desc || "ç„¡æè¿°å…§å®¹";
                } else {
                    vRes.innerHTML = "<span class='verify-fail'>âš ï¸ è­¦å‘Šï¼šç°½ç« ä¸ç¬¦ï¼Œå¯èƒ½æ˜¯å½é€ æ¨™ç±¤ï¼</span>";
                    document.getElementById('vTitle').innerText = "æ””æˆªå­˜å–";
                    document.getElementById('vDesc').innerText = "";
                }
            };
        } catch (e) { alert("è®€å–å¤±æ•—"); }
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
</script>
</body>
</html>
