<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS ç§‘æŠ€ - æœ¬åœ°å„²å­˜ç³»çµ± v4</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #00d2ff; --bg: #0a0a0c; --card: #16161d; --text: #f0f0f0; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        header { background: #1a1a24; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); position: sticky; top: 0; z-index: 100; }
        .menu-btn { cursor: pointer; font-size: 1.8rem; color: var(--primary); }
        #drawer { position: fixed; top: 0; right: -280px; width: 260px; height: 100%; background: var(--card); transition: 0.3s; z-index: 1000; padding-top: 60px; }
        .menu-item { padding: 20px; border-bottom: 1px solid #333; cursor: pointer; }
        .container { padding: 20px; max-width: 600px; margin: auto; }
        .mode-section { display: none; }
        .active { display: block; }
        input, textarea { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 12px; margin: 10px 0; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-save { background: var(--primary); color: #000; }
        .btn-scan { background: #6f42c1; color: #fff; }
        #preview, #viewImg { width: 100%; border-radius: 12px; margin-top: 15px; display: none; }
        #viewArea { background: #1a1a24; padding: 20px; border-radius: 15px; margin-top: 20px; display: none; border: 1px solid var(--primary); }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; letter-spacing: 2px; color: var(--primary);">RMS TECH V4</div>
    <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
</header>

<div id="drawer">
    <div class="menu-item" onclick="switchMode('write')">âœï¸ 1. å¯«å…¥æ–°é…æª”</div>
    <div class="menu-item" onclick="switchMode('read')">ğŸ“– 2. è®€å– NFC æ¨™ç±¤</div>
</div>

<div class="container">
    <div id="writeSection" class="mode-section">
        <h2 style="color:var(--primary)">å¯«å…¥æ¨¡å¼</h2>
        <input type="text" id="editTitle" placeholder="æ¨™é¡Œ">
        <textarea id="editDesc" rows="4" placeholder="æè¿°å…§å®¹..."></textarea>
        <input type="file" id="fileInput" accept="image/*" onchange="previewImage(this)">
        <img id="preview">
        <button class="btn btn-save" onclick="saveAndPair()">ğŸ’¾ å„²å­˜ä¸¦å¯«å…¥ NFC</button>
    </div>

    <div id="readSection" class="mode-section active">
        <h2 style="color:var(--primary)">è®€å–æ¨¡å¼</h2>
        <button class="btn btn-scan" onclick="startScan()">ğŸ“³ é–‹å§‹æ„Ÿæ‡‰æ¨™ç±¤</button>
        <div id="viewArea">
            <h3 id="viewTitle" style="color:var(--primary);"></h3>
            <p id="viewDesc"></p>
            <img id="viewImg">
        </div>
    </div>
</div>

<script>
    let base64Image = "";

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    function toggleMenu() {
        const drawer = document.getElementById('drawer');
        drawer.style.right = (drawer.style.right === '0px') ? '-280px' : '0px';
    }

    function switchMode(mode) {
        document.querySelectorAll('.mode-section').forEach(s => s.classList.remove('active'));
        document.getElementById(mode + 'Section').classList.add('active');
        toggleMenu();
    }

    function previewImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            base64Image = e.target.result;
            document.getElementById('preview').src = base64Image;
            document.getElementById('preview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    async function saveAndPair() {
        const title = document.getElementById('editTitle').value;
        const desc = document.getElementById('editDesc').value;
        if (!title) return alert("æ¨™é¡Œå¿…å¡«");

        const pairId = "RMS_" + Date.now();
        const rmsData = { title, desc, image: base64Image, id: pairId, time: new Date().toLocaleString() };

        try {
            // 1. æœ¬åœ°å„²å­˜
            localStorage.setItem(pairId, JSON.stringify(rmsData));

            // 2. ä¸‹è¼‰ JSON
            const blob = new Blob([JSON.stringify(rmsData)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${pairId}.json`;
            a.click();

            // 3. NFC å¯«å…¥
            const ndef = new NDEFReader();
            await ndef.write(pairId);
            alert("âœ… æˆåŠŸï¼æ¨™ç±¤å·²é…å°ï¼Œæª”æ¡ˆå·²ä¸‹è¼‰å‚™ä»½ã€‚");
            location.reload();
        } catch (e) { alert("éŒ¯èª¤ï¼š" + e); }
    }

    async function startScan() {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            alert("è«‹é è¿‘ NFC æ¨™ç±¤...");
            ndef.onreading = ({ message }) => {
                const pairId = new TextDecoder().decode(message.records[0].data);
                const localData = localStorage.getItem(pairId);
                if (localData) {
                    const data = JSON.parse(localData);
                    document.getElementById('viewArea').style.display = 'block';
                    document.getElementById('viewTitle').innerText = data.title;
                    document.getElementById('viewDesc').innerText = data.desc;
                    document.getElementById('viewImg').src = data.image || "";
                    document.getElementById('viewImg').style.display = data.image ? "block" : "none";
                } else {
                    alert("æœ¬åœ°æ‰¾ä¸åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºæœ¬æ©Ÿå„²å­˜æˆ–éœ€åŒ¯å…¥ JSONã€‚");
                }
            };
        } catch (e) { alert("è®€å–å¤±æ•—ï¼š" + e); }
    }
</script>
</body>
</html>
